<% @page_class = 'AxB' -%>
<div id="content_header">
  <%= link_to "« Tillbaka till översikt", admin_activities_path, :class => 'back' %>
  <h1>Världsföräldrar</h1>
</div>
<div id="container">
  <div id="content">
    <div id="ca">
      <div class="inner">
        <%= render :partial => 'activities_nav', :locals => {:type => @type} %>
      </div>
    </div>
    <div id="cb">
      <div class="inner">
        <% activity_table(@first_period, @second_period, {:export_links => true}) do %>
          <tbody>
            <tr class="totals">
              <th scope="colgroup">Anmälda</th>
              <% num_first_period, num_second_period = GlobalParent.with_period(@first_period).count, GlobalParent.with_period(@second_period).count -%>
              <% diff = num_first_period - num_second_period -%>
              <td><%= num_second_period %> st</td>
              <td><%= num_first_period %> st</td>
              <td><%= '+' if diff > 0 %><%= diff %> st</td>
            </tr>
            <tr>
              <th scope="row">Onlinebetalningar</th>
              <% num_first_period_payers, num_second_period_payers = GlobalParent.with_period(@first_period).with_payment.count, GlobalParent.with_period(@second_period).with_payment.count -%>
              <% diff = num_first_period_payers - num_second_period_payers %>
              <td>
              <% if num_second_period_payers > 0 -%>
                <%= num_second_period_payers %> st / <%= number_to_percentage((num_second_period_payers.to_f / num_second_period.to_f) * 100, :precision => 2) %>
              <% else -%>
                -
              <% end -%>
              </td>
              <td>
              <% if num_first_period_payers > 0 -%>
                <%= num_first_period_payers %> st / <%= number_to_percentage((num_first_period_payers.to_f / num_first_period.to_f) * 100, :precision => 2) %>
              <% else -%>
                -
              <% end -%>
              </td>
              <td><%= '+' if diff > 0 %><%= diff == 0 ? '-' : "#{diff} st" %></td>
            </tr>
            <tr>
              <th scope="row">AutoGiro</th>
              <% num_first_period_not_online, num_second_period_not_online = (num_first_period - num_first_period_payers), (num_second_period - num_second_period_payers) %>
              <% diff = num_first_period_not_online - num_second_period_not_online %>
              <td>
              <% if num_second_period_not_online > 0 -%>
                <%= num_second_period_not_online %> st / <%= number_to_percentage((num_second_period_not_online.to_f / num_second_period.to_f) * 100, :precision => 2) %>
              <% else -%>
                -
              <% end -%>
              </td>
              <td>
              <% if num_first_period_not_online > 0 -%>
                <%= num_first_period_not_online %> st / <%= number_to_percentage((num_first_period_not_online.to_f / num_first_period.to_f) * 100, :precision => 2)  %>
              <% else -%>
                -
              <% end -%>
              </td>
              <td>
                <%= '+' if diff > 0 %><%= diff %> st
              </td>
            </tr>
            <tr>
              <th scope="row">Genomsnittligt värde</th>
              <% average_sum_first_period, average_sum_second_period = GlobalParent.average_sum(:period => @first_period), GlobalParent.average_sum(:period => @second_period) -%>
              <% diff = average_sum_first_period - average_sum_second_period %>
              <td><%= number_to_currency average_sum_second_period.to_f, :precision => 2 %></td>
              <td><%= number_to_currency average_sum_first_period.to_f, :precision => 2 %></td>
              <td><%= '+' if diff.cents > 0 %><%= number_to_currency diff.to_f, :precision => 2 %></td>
            </tr>
            <tr>
              <th scope="row">Ca intäkt 12 mån</th>
              <% total_sum_first_period, total_sum_second_period = Money.new(num_first_period * average_sum_first_period.cents * 12), Money.new(num_second_period * average_sum_second_period.cents * 12)  %>
              <% diff = total_sum_first_period - total_sum_second_period %>
              <td><%= number_to_currency total_sum_second_period.to_f %></td>
              <td><%= number_to_currency total_sum_first_period.to_f %></td>
              <td><%= '+' if diff.cents > 0 %><%= number_to_currency diff.to_f %></td>
            </tr>
            <tr>
              <th scope="row">Opt-in</th>
              <% num_first_period_opt_in, num_second_period_opt_in = GlobalParent.with_period(@first_period).with_opt_in.count, GlobalParent.with_period(@second_period).with_opt_in.count -%>
              <% first_period_percent = (num_first_period_opt_in.to_f / num_first_period.to_f) * 100 -%>
              <% second_period_percent = (num_second_period_opt_in.to_f / num_second_period.to_f) * 100 -%>
              <% diff = num_first_period_opt_in - num_second_period_opt_in %>
              <td>
              <% if num_second_period_opt_in > 0 %>
                <%= num_second_period_opt_in %> st / <%= number_to_percentage second_period_percent, :precision => 3 %>
              <% else -%>
                -
              <% end -%>
              </td>
              <td>
              <% if num_first_period_opt_in > 0 %>
                <%= num_first_period_opt_in %> st / <%= number_to_percentage first_period_percent, :precision => 3 %>
              <% else -%>
                -
              <% end -%>
              </td>
              <td><%= '+' if (first_period_percent - second_period_percent) > 0 %><%= number_to_percentage((first_period_percent - second_period_percent), :precision => 3) %></td>
            </tr>
          </tbody>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%= javascript_include_merged :admin %>